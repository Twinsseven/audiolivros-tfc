{% extends "tfc/layout.html" %}

{% block title %}{{ audiolivro.titulo }}{% endblock %}

{% block content %}
    {% load static %}
    <link rel="stylesheet" type="text/css" href="{% static 'tfc/estilos.css' %}">

    <div class="detalhes-audiolivro">
        <div class="audio-player-card">
            <div class="card-detalhes shadow-sm">
                <img src="{{ audiolivro.capa.url }}" class="card-img-top" alt="Capa de {{ audiolivro.titulo }}">
                <div class="card-body">
                    <p><strong>Autor:</strong> {{ audiolivro.autor }}</p>
                    <p><strong>Gravado por:</strong> {{ audiolivro.gravado_por.nome|default:"Desconhecido" }}</p>

            <!-- Player de √°udio -->
                    {% if audiolivro.audio %}
                        <audio controls class="audio-player">
                            <source src="{{ audiolivro.audio.url }}" type="audio/mpeg">
                            O seu navegador n√£o suporta a reprodu√ß√£o de √°udio.
                        </audio>
                    {% else %}
                        <p><em>Sem √°udio dispon√≠vel</em></p>
                    {% endif %}
                </div>
            </div>
        </div>


        <div class="comentarios-container">
            <h3>Coment√°rios</h3>

            <!-- Formul√°rio para Criar Coment√°rio -->
            <form id="comentarioForm" action="{% url 'tfc:criarComentarioInline' audiolivro_id=audiolivro.id %}" method="POST" enctype="multipart/form-data">
                {% csrf_token %}
                <textarea name="texto" class="comentario-texto" placeholder="Escreva o seu coment√°rio..." rows="3"></textarea>

                <div class="botoes-gravacao">
                    <button type="button" id="btnGravar" class="botao-gravar">üé§ Gravar</button>
                    <button type="button" id="btnParar" class="botao-parar" disabled>‚èπÔ∏è Parar</button>
                </div>

                <button type="submit" class="botao-publicar">Publicar</button>
            </form>

            <!-- Coment√°rios Publicados -->
            <div class="comentarios">
                {% for comment in comentario %}
                    <div class="comentario">
                        <p class="autor">{{ comment.autor.nome }}</p>
                        <p>{{ comment.texto }}</p>
                        {% if comment.audio %}
                            <audio controls>
                                <source src="{{ comment.audio.url }}" type="audio/mpeg">
                                O seu navegador n√£o suporta a reprodu√ß√£o de √°udio.
                            </audio>
                        {% endif %}
                    </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Script para Grava√ß√£o de √Åudio -->
    <script>
        let mediaRecorder;
        let audioChunks = [];

        const btnGravar = document.getElementById('btnGravar');
        const btnParar = document.getElementById('btnParar');
        const audioInput = document.getElementById('audioComentario');

        navigator.mediaDevices.getUserMedia({ audio: true })
            .then(stream => {
                mediaRecorder = new MediaRecorder(stream);

                mediaRecorder.addEventListener("dataavailable", event => {
                    audioChunks.push(event.data);
                });

                mediaRecorder.addEventListener("stop", () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/mpeg' });
                    audioChunks = [];
                    const file = new File([audioBlob], "comentario_audio.mp3", { type: 'audio/mpeg' });
                    const dataTransfer = new DataTransfer();
                    dataTransfer.items.add(file);
                    audioInput.files = dataTransfer.files;
                });

                btnGravar.addEventListener("click", () => {
                    mediaRecorder.start();
                    btnGravar.disabled = true;
                    btnParar.disabled = false;
                });

                btnParar.addEventListener("click", () => {
                    mediaRecorder.stop();
                    btnGravar.disabled = false;
                    btnParar.disabled = true;
                });
            })
            .catch(error => {
                console.error("Erro ao acessar o microfone: ", error);
                btnGravar.disabled = true;
                btnParar.disabled = true;
            });
    </script>
{% endblock %}
